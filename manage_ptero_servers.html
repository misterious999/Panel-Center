<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kelola Server Pterodactyl</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root { 
            --bg-color: #0f172a; 
            --card-bg: #1e293b; 
            --primary: #3b82f6; 
            --success: #10b981; 
            --danger: #ef4444; 
            --warning: #f59e0b; 
            --text-main: #f8fafc; 
            --text-sub: #94a3b8; 
            --border-color: rgba(255,255,255,0.1);
        }
        
        body { 
            font-family: 'Inter', sans-serif; 
            padding: 20px; 
            background-color: var(--bg-color); 
            color: var(--text-main); 
            margin: 0; 
        }

        h2 { font-weight: 700; margin-bottom: 5px; color: var(--text-main); }
        .sub-title { color: var(--text-sub); margin-bottom: 25px; font-size: 14px; }

        .btn-back {
            display: inline-block;
            margin-bottom: 20px;
            padding: 10px 15px;
            background: rgba(255,255,255,0.05);
            color: var(--text-main);
            text-decoration: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            border: 1px solid var(--border-color);
            transition: 0.2s;
        }
        .btn-back:hover { background: var(--card-bg); transform: translateX(-3px); }

        .box { 
            background: var(--card-bg); 
            padding: 20px; 
            border-radius: 16px; 
            border: 1px solid var(--border-color); 
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            overflow-x: auto;
        }

        .box h3 { margin-top: 0; font-size: 18px; margin-bottom: 15px; display: flex; align-items: center; gap: 8px; }

        /* Styling Tabel Server */
        table { width: 100%; border-collapse: collapse; min-width: 600px; margin-top: 10px; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid var(--border-color); font-size: 14px; }
        th { background: rgba(255,255,255,0.02); color: var(--text-sub); font-weight: 600; text-transform: uppercase; font-size: 12px; letter-spacing: 1px; }
        tr:hover { background: rgba(255,255,255,0.02); }

        /* Tombol Aksi */
        .btn-action {
            cursor: pointer; 
            border-radius: 6px; 
            padding: 6px 12px; 
            font-weight: 600;
            font-size: 12px;
            transition: 0.2s;
            border: none;
            margin-right: 5px;
            margin-bottom: 5px;
            display: inline-block;
            white-space: nowrap; /* MANTRA ANTI-ENTER BIAR TOMBOL GAK PATAH */
        }
        .btn-hapus { background: rgba(239, 68, 68, 0.1); color: var(--danger); border: 1px solid var(--danger); }
        .btn-hapus:hover { background: var(--danger); color: white; }
        
        .btn-suspend { background: rgba(245, 158, 11, 0.1); color: var(--warning); border: 1px solid var(--warning); }
        .btn-suspend:hover { background: var(--warning); color: white; }

        .btn-unsuspend { background: rgba(16, 185, 129, 0.1); color: var(--success); border: 1px solid var(--success); }
        .btn-unsuspend:hover { background: var(--success); color: white; }

        /* Badge Status */
        .badge { 
            padding: 4px 10px; 
            border-radius: 6px; 
            font-size: 11px; 
            font-weight: bold; 
            text-transform: uppercase; 
            letter-spacing: 0.5px; 
            display: inline-block;
            white-space: nowrap; /* MANTRA ANTI-ENTER BIAR STATUS RAPI */
        }
        .badge-aktif { background: rgba(16, 185, 129, 0.2); color: var(--success); border: 1px solid var(--success); }
        .badge-suspend { background: rgba(239, 68, 68, 0.2); color: var(--danger); border: 1px solid var(--danger); }
        
        .server-name { font-weight: 600; color: var(--text-main); font-size: 15px; }
        .server-uuid { color: var(--text-sub); font-size: 11px; font-family: monospace; display: block; margin-top: 3px; }
    </style>
</head>
<body>
    <a href="index.html" class="btn-back">‚¨Ö Kembali ke Dashboard</a>
    
    <h2>Kelola Server Pterodactyl</h2>
    <p class="sub-title">Pantau, Suspend, atau Hapus server pelanggan secara langsung.</p>

    <div class="box">
        <h3>üñ•Ô∏è Daftar Semua Server</h3>
        <table id="tabelServers">
            <tr>
                <th>ID</th>
                <th>Info Server</th>
                <th>Node / RAM</th>
                <th>Status</th>
                <th>Aksi Cepat</th>
            </tr>
            <tr>
                <td colspan="5" style="text-align: center; color: var(--text-sub); padding: 20px;">
                    <span style="font-size: 20px; display: block; margin-bottom: 10px;">‚è≥</span>
                    Sedang mengambil data server dari Pterodactyl...
                </td>
            </tr>
        </table>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <script>
        // 1. CEK LOGIN FIREBASE DULU
        const currentUserId = localStorage.getItem('user_id');
        if (!currentUserId) window.location.replace("login.html");

        // 2. DATA API PTERODACTYL
        const PTERO_DOMAIN = "zeroix.panel-prvt.web.id"; 
        const PTERO_API_APP = "ptla_ZM2Ka67FdLj62khENxUm22bKnsHHDBhUCEnDtXfuHhw"; 
        const WORKER_URL = "https://restless-truth-9b75.amisterious09.workers.dev"; 

        // 3. FUNGSI AMBIL DATA SERVER
        function ambilDataServers() {
            let targetUrl = `${WORKER_URL}/?https://${PTERO_DOMAIN}/api/application/servers`;
            
            fetch(targetUrl, {
                method: 'GET',
                headers: {
                    'Accept': 'application/json',
                    'Authorization': `Bearer ${PTERO_API_APP}`
                }
            })
            .then(res => {
                if (!res.ok) throw new Error("Gagal mengambil data dari API!");
                return res.json();
            })
            .then(data => {
                let servers = data.data;
                let tabel = `<tr>
                    <th>ID</th>
                    <th>Info Server</th>
                    <th>Node / RAM</th>
                    <th>Status</th>
                    <th>Aksi Cepat</th>
                </tr>`;

                if (servers.length === 0) {
                    tabel += `<tr><td colspan="5" style="text-align: center; color: var(--warning);">Belum ada server yang dibuat.</td></tr>`;
                }

                servers.forEach(server => {
                    let s = server.attributes;
                    
                    let statusBadge = s.suspended ? 
                        `<span class="badge badge-suspend">üî¥ Suspended</span>` : 
                        `<span class="badge badge-aktif">üü¢ Aktif</span>`;
                        
                    let btnSuspend = s.suspended ?
                        `<button class="btn-action btn-unsuspend" onclick="ubahStatusServer(${s.id}, 'unsuspend', '${s.name}')">‚ñ∂Ô∏è Unsuspend</button>` :
                        `<button class="btn-action btn-suspend" onclick="ubahStatusServer(${s.id}, 'suspend', '${s.name}')">‚è∏Ô∏è Suspend</button>`;

                    let ram = s.limits.memory === 0 ? "Unlimited" : s.limits.memory + " MB";

                    tabel += `<tr>
                        <td style="color: var(--text-sub); font-weight: bold;">#${s.id}</td>
                        <td>
                            <span class="server-name">${s.name}</span>
                            <span class="server-uuid">${s.uuid.split('-')[0]}...</span>
                        </td>
                        <td style="color: var(--text-main); font-size: 13px;">
                            ${s.node}<br>
                            <span style="color: var(--text-sub); font-size: 11px;">RAM: ${ram}</span>
                        </td>
                        <td>${statusBadge}</td>
                        <td>
                            ${btnSuspend}
                            <button class="btn-action btn-hapus" onclick="hapusServer(${s.id}, '${s.name}')">üóëÔ∏è Hapus</button>
                        </td>
                    </tr>`;
                });
                
                document.getElementById('tabelServers').innerHTML = tabel;
            })
            .catch(error => {
                document.getElementById('tabelServers').innerHTML = `<tr><td colspan="5" style="text-align: center; color: var(--danger);">‚ùå Error: ${error.message}</td></tr>`;
            });
        }

        // 4. FUNGSI SUSPEND / UNSUSPEND SERVER
        function ubahStatusServer(id, aksi, namaServer) {
            let labelAksi = aksi === 'suspend' ? 'MEMBEKUKAN (Suspend)' : 'MENGAKTIFKAN KEMBALI (Unsuspend)';
            let konfirmasi = confirm(`Yakin ingin ${labelAksi} server "${namaServer}"?`);
            
            if (!konfirmasi) return;

            let targetUrl = `${WORKER_URL}/?https://${PTERO_DOMAIN}/api/application/servers/${id}/${aksi}`;

            fetch(targetUrl, {
                method: 'POST',
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${PTERO_API_APP}`
                }
            })
            .then(res => {
                if (!res.ok) throw new Error("Gagal mengubah status server!");
                alert(`‚úÖ Server "${namaServer}" berhasil di-${aksi}!`);
                ambilDataServers(); 
            })
            .catch(err => {
                alert(`‚ùå Gagal: ${err.message}`);
            });
        }

        // 5. FUNGSI HAPUS SERVER PERMANEN
        function hapusServer(id, namaServer) {
            let konfirmasi = confirm(`üö® PERINGATAN KERAS!\n\nYakin ingin MENGHAPUS server "${namaServer}" secara permanen?\nSemua file dan data di dalam server ini akan musnah dan tidak bisa dikembalikan!`);
            
            if (!konfirmasi) return;

            let targetUrl = `${WORKER_URL}/?https://${PTERO_DOMAIN}/api/application/servers/${id}/force`;

            fetch(targetUrl, {
                method: 'DELETE',
                headers: {
                    'Accept': 'application/json',
                    'Authorization': `Bearer ${PTERO_API_APP}`
                }
            })
            .then(res => {
                if (!res.ok) throw new Error("Gagal menghapus server!");
                alert(`üí• DUAARR! Server "${namaServer}" berhasil dimusnahkan!`);
                ambilDataServers(); 
            })
            .catch(err => {
                alert(`‚ùå Gagal: ${err.message}`);
            });
        }

        ambilDataServers();
    </script>
</body>
</html>
