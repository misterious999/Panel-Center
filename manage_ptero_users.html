<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kelola User Pterodactyl</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .box { border: 1px solid #ccc; padding: 15px; margin-bottom: 20px; border-radius: 8px; background: #f9f9f9; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; background: white; min-width: 400px; }
        table, th, td { border: 1px solid #aaa; }
        th, td { padding: 10px; text-align: left; }
        a { text-decoration: none; color: blue; font-weight: bold; }
        input, select { padding: 8px; margin-top: 5px; width: 90%; max-width: 300px; display: block; border: 1px solid #ccc; border-radius: 4px; }
        .btn-tambah { background: #28a745; color: white; border: none; cursor: pointer; border-radius: 4px; padding: 10px 15px; font-weight: bold; margin-top: 10px;}
        .btn-hapus { background: #dc3545; color: white; border: none; cursor: pointer; border-radius: 4px; padding: 5px 10px; font-weight: bold; }
        .btn-hapus:hover { background: #c82333; }
        .badge-admin { background: #dc3545; color: white; padding: 3px 8px; border-radius: 4px; font-size: 12px;}
        .badge-user { background: #007bff; color: white; padding: 3px 8px; border-radius: 4px; font-size: 12px;}
    </style>
</head>
<body>
    <h2>Kelola User Pterodactyl</h2>
    <a href="index.html">‚¨Ö Kembali ke Dashboard</a>

    <div class="box">
        <h3>‚ûï Buat Akun Pterodactyl Baru</h3>
        <label>Username (Tanpa Spasi):</label>
        <input type="text" id="newUsername" placeholder="Ketik username...">
        
        <label>Email:</label>
        <input type="email" id="newEmail" placeholder="Ketik email aktif...">
        
        <label>Password:</label>
        <input type="text" id="newPassword" placeholder="Ketik password...">

        <div id="roleContainer">
            <label style="margin-top: 10px; display: block; font-weight: bold;">Tipe Akun (Role):</label>
            <select id="newRole">
                <option value="false">üë§ Member Biasa</option>
                <option value="true">üëë Admin Panel (Akses Penuh)</option>
            </select>
        </div>
        
        <button class="btn-tambah" onclick="buatUserPtero()">üöÄ Buat User Sekarang</button>
    </div>

    <div class="box">
        <h3>üìã Semua User di Panel</h3>
        <table id="tabelPtero">
            <tr>
                <th>ID</th>
                <th>Username</th>
                <th>Email</th>
                <th>Status</th>
                <th>Aksi</th>
            </tr>
            <tr>
                <td colspan="5">‚è≥ Sedang mengambil data dari Pterodactyl...</td>
            </tr>
        </table>
    </div>

    <script>
        // Cek Login
        let userRole = localStorage.getItem('role');
        if (!userRole) {
            alert("Harap login terlebih dahulu!");
            window.location.replace("login.html");
        }

        // ==========================================
        // FITUR KEAMANAN: HILANGKAN OPSI ADMIN BUAT RESELLER
        // ==========================================
        if (userRole && userRole.toLowerCase() === 'reseller') {
            document.getElementById('roleContainer').style.display = 'none';
        }

        // ==========================================
        // 1. DATA RAHASIA
        // ==========================================
        const PTERO_DOMAIN = "zeroix.panel-prvt.web.id"; 
        const PTERO_API = "ptla_ZM2Ka67FdLj62khENxUm22bKnsHHDBhUCEnDtXfuHhw"; 
        const WORKER_URL = "https://restless-truth-9b75.amisterious09.workers.dev"; 
        
        // ==========================================
        // 2. FUNGSI MENAMPILKAN DATA (READ)
        // ==========================================
        function ambilDataPtero() {
            let targetUrl = `${WORKER_URL}/?https://${PTERO_DOMAIN}/api/application/users`;
            
            fetch(targetUrl, {
                method: 'GET',
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${PTERO_API}`
                }
            })
            .then(async response => {
                if (!response.ok) throw new Error("Gagal ngambil data!");
                return response.json();
            })
            .then(data => {
                let users = data.data;
                let tabel = `<tr><th>ID</th><th>Username</th><th>Email</th><th>Status</th><th>Aksi</th></tr>`;
                
                users.forEach(user => {
                    let u = user.attributes;
                    
                    // Sembunyikan admin dari layar reseller
                    if (userRole === 'reseller' && u.root_admin === true) return; 
                    
                    let status = u.root_admin ? `<span class="badge-admin">Admin</span>` : `<span class="badge-user">Member</span>`;
                    
                    let tombolHapus = "";
                    if (u.id !== 1) {
                        tombolHapus = `<button class="btn-hapus" onclick="hapusUserPtero(${u.id}, '${u.username}')">üóëÔ∏è Hapus</button>`;
                    } else {
                        tombolHapus = `<small style="color:gray;">Bawaan Sistem</small>`;
                    }

                    tabel += `<tr>
                        <td>${u.id}</td>
                        <td>${u.username}</td>
                        <td>${u.email}</td>
                        <td>${status}</td>
                        <td>${tombolHapus}</td>
                    </tr>`;
                });
                document.getElementById('tabelPtero').innerHTML = tabel;
            })
            .catch(error => {
                document.getElementById('tabelPtero').innerHTML = `<tr><td colspan="5" style="color:red;">‚ùå Error: ${error.message}</td></tr>`;
            });
        }

        // ==========================================
        // 3. FUNGSI MEMBUAT USER BARU (CREATE)
        // ==========================================
        function buatUserPtero() {
            let targetUrl = `${WORKER_URL}/?https://${PTERO_DOMAIN}/api/application/users`;
            let username = document.getElementById('newUsername').value;
            let email = document.getElementById('newEmail').value;
            let password = document.getElementById('newPassword').value;
            
            let isAdmin = document.getElementById('newRole').value === "true"; 

            if(username === "" || email === "" || password === "") {
                alert("Semua kolom (Username, Email, Password) wajib diisi ya!");
                return;
            }

            let dataPayload = {
                "email": email,
                "username": username,
                "first_name": username, 
                "last_name": isAdmin ? "Admin" : "User",    
                "password": password,
                "root_admin": isAdmin 
            };

            fetch(targetUrl, {
                method: 'POST',
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${PTERO_API}`
                },
                body: JSON.stringify(dataPayload)
            })
            .then(async response => {
                if (!response.ok) {
                    let err = await response.text();
                    throw new Error(err);
                }
                return response.json();
            })
            .then(data => {
                let statusTeks = isAdmin ? "sebagai ADMIN üëë" : "sebagai MEMBER üë§";
                alert(`üéâ Mantap! User ${username} berhasil dibuat ${statusTeks}!`);
                
                document.getElementById('newUsername').value = "";
                document.getElementById('newEmail').value = "";
                document.getElementById('newPassword').value = "";
                document.getElementById('newRole').value = "false"; 
                
                ambilDataPtero();
            })
            .catch(error => {
                alert("Yah, gagal bikin user. Alasan: " + error.message);
            });
        }

        // ==========================================
        // 4. FUNGSI MENGHAPUS USER (DELETE)
        // ==========================================
        function hapusUserPtero(userId, username) {
            let konfirmasi = confirm(`üö® PERINGATAN!\nYakin mau menghapus user "${username}" (ID: ${userId}) secara permanen dari Pterodactyl?`);
            
            if (!konfirmasi) return; 

            let deleteUrl = `${WORKER_URL}/?https://${PTERO_DOMAIN}/api/application/users/${userId}`;

            fetch(deleteUrl, {
                method: 'DELETE',
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${PTERO_API}`
                }
            })
            .then(async response => {
                if (!response.ok) {
                    let err = await response.text();
                    throw new Error(err);
                }
                alert(`üí• DUAARR! User ${username} berhasil dihapus selamanya dari Pterodactyl!`);
                ambilDataPtero(); 
            })
            .catch(error => {
                alert("Gagal menghapus user. Alasan: " + error.message);
                console.error(error);
            });
        }

        ambilDataPtero();
    </script>
</body>
</html>
