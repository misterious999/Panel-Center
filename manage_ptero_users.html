<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kelola User Pterodactyl</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root { 
            --bg-color: #0f172a; 
            --card-bg: #1e293b; 
            --primary: #3b82f6; 
            --success: #10b981; 
            --danger: #ef4444; 
            --warning: #f59e0b; 
            --text-main: #f8fafc; 
            --text-sub: #94a3b8; 
            --input-bg: #0f172a;
            --border-color: rgba(255,255,255,0.1);
        }
        
        body { 
            font-family: 'Inter', sans-serif; 
            padding: 20px; 
            background-color: var(--bg-color); 
            color: var(--text-main); 
            margin: 0; 
        }

        h2 { font-weight: 700; margin-bottom: 5px; color: var(--text-main); }
        .sub-title { color: var(--text-sub); margin-bottom: 25px; font-size: 14px; }

        .btn-back {
            display: inline-block;
            margin-bottom: 20px;
            padding: 10px 15px;
            background: rgba(255,255,255,0.05);
            color: var(--text-main);
            text-decoration: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            border: 1px solid var(--border-color);
            transition: 0.2s;
        }
        .btn-back:hover { background: var(--card-bg); transform: translateX(-3px); }

        .box { 
            background: var(--card-bg); 
            padding: 20px; 
            border-radius: 16px; 
            border: 1px solid var(--border-color); 
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            overflow-x: auto;
        }

        .box h3 { margin-top: 0; font-size: 18px; margin-bottom: 15px; display: flex; align-items: center; gap: 8px; }

        label {
            display: block;
            margin-bottom: 5px;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-sub);
        }

        input, select { 
            width: 100%; 
            padding: 12px; 
            margin-bottom: 15px;
            background: var(--input-bg); 
            border: 1px solid var(--border-color); 
            border-radius: 8px; 
            color: var(--text-main); 
            font-size: 14px; 
            box-sizing: border-box;
            outline: none;
            transition: 0.2s;
        }
        input:focus, select:focus { border-color: var(--primary); box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2); }

        .btn-tambah { 
            width: 100%;
            background: var(--primary); 
            color: white; 
            border: none; 
            cursor: pointer; 
            border-radius: 8px; 
            padding: 12px; 
            font-weight: bold; 
            transition: 0.2s;
            margin-top: 5px;
        }
        .btn-tambah:hover { background: #2563eb; transform: translateY(-2px); }

        /* Styling Tabel */
        table { width: 100%; border-collapse: collapse; min-width: 500px; margin-top: 10px; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid var(--border-color); font-size: 14px; }
        th { background: rgba(255,255,255,0.02); color: var(--text-sub); font-weight: 600; text-transform: uppercase; font-size: 12px; letter-spacing: 1px; }
        tr:hover { background: rgba(255,255,255,0.02); }

        .btn-hapus { 
            background: rgba(239, 68, 68, 0.1); 
            color: var(--danger); 
            border: 1px solid var(--danger); 
            cursor: pointer; 
            border-radius: 6px; 
            padding: 6px 12px; 
            font-weight: 600;
            font-size: 12px;
            transition: 0.2s;
            white-space: nowrap;
        }
        .btn-hapus:hover { background: var(--danger); color: white; }

        .badge { 
            padding: 4px 10px; 
            border-radius: 6px; 
            font-size: 11px; 
            font-weight: bold; 
            text-transform: uppercase; 
            letter-spacing: 0.5px; 
            display: inline-block;
            white-space: nowrap;
        }
        .badge-admin { background: rgba(245, 158, 11, 0.2); color: var(--warning); border: 1px solid var(--warning); }
        .badge-user { background: rgba(59, 130, 246, 0.2); color: var(--primary); border: 1px solid var(--primary); }
    </style>
</head>
<body>
    <a href="index.html" class="btn-back">‚¨Ö Kembali ke Dashboard</a>
    
    <h2>Kelola User Pterodactyl</h2>
    <p class="sub-title">Buat dan hapus akun login untuk panel Pterodactyl pelanggan.</p>

    <div class="box">
        <h3>‚ûï Buat Akun Pterodactyl Baru</h3>
        
        <label>Username (Tanpa Spasi):</label>
        <input type="text" id="newUsername" placeholder="Ketik username..." autocomplete="off">
        
        <label>Email Aktif:</label>
        <input type="email" id="newEmail" placeholder="contoh@gmail.com" autocomplete="off">
        
        <label>Password:</label>
        <input type="text" id="newPassword" placeholder="Ketik password yang kuat..." autocomplete="off">

        <div id="roleContainer">
            <label>Tipe Akun (Pterodactyl Role):</label>
            <select id="newRole">
                <option value="false">üë§ Member Biasa</option>
                <option value="true">üëë Admin Panel (Akses Penuh)</option>
            </select>
        </div>
        
        <button class="btn-tambah" onclick="buatUserPtero()">üöÄ Buat User Sekarang</button>
    </div>

    <div class="box">
        <h3>üìã Semua User di Pterodactyl</h3>
        <table id="tabelPtero">
            <tr>
                <th>ID</th>
                <th>Username</th>
                <th>Email</th>
                <th>Status</th>
                <th>Aksi</th>
            </tr>
            <tr>
                <td colspan="5" style="text-align: center; color: var(--text-sub); padding: 20px;">
                    <span style="font-size: 20px; display: block; margin-bottom: 10px;">‚è≥</span>
                    Sedang mengambil data dari Pterodactyl...
                </td>
            </tr>
        </table>
    </div>

    <script>
        // Cek Login Panel
        let currentUserId = localStorage.getItem('user_id');
        let userRole = localStorage.getItem('role');
        if (!currentUserId) {
            window.location.replace("login.html");
        }

        // Sembunyikan Opsi Admin Buat Reseller
        if (userRole && userRole.toLowerCase() === 'reseller') {
            document.getElementById('roleContainer').style.display = 'none';
        }

        // API DATA
        const PTERO_DOMAIN = "zeroix.panel-prvt.web.id"; 
        const PTERO_API = "ptla_ZM2Ka67FdLj62khENxUm22bKnsHHDBhUCEnDtXfuHhw"; 
        const WORKER_URL = "https://restless-truth-9b75.amisterious09.workers.dev"; 
        
        // FUNGSI TAMPIL DATA
        function ambilDataPtero() {
            let targetUrl = `${WORKER_URL}/?https://${PTERO_DOMAIN}/api/application/users`;
            
            fetch(targetUrl, {
                method: 'GET',
                headers: {
                    'Accept': 'application/json',
                    'Authorization': `Bearer ${PTERO_API}`
                }
            })
            .then(async response => {
                if (!response.ok) throw new Error("Gagal ngambil data!");
                return response.json();
            })
            .then(data => {
                let users = data.data;
                let tabel = `<tr><th>ID</th><th>Username</th><th>Email</th><th>Status</th><th>Aksi</th></tr>`;
                
                users.forEach(user => {
                    let u = user.attributes;
                    
                    // Sembunyikan admin dari layar reseller
                    if (userRole === 'reseller' && u.root_admin === true) return; 
                    
                    let status = u.root_admin ? `<span class="badge badge-admin">üëë Admin</span>` : `<span class="badge badge-user">üë§ Member</span>`;
                    
                    // Sembunyikan tombol hapus untuk ID 1 (Owner Utama Ptero)
                    let tombolHapus = "";
                    if (u.id !== 1) {
                        tombolHapus = `<button class="btn-hapus" onclick="hapusUserPtero(${u.id}, '${u.username}')">üóëÔ∏è Hapus</button>`;
                    } else {
                        tombolHapus = `<span style="color:var(--text-sub); font-size:12px;">Bawaan Sistem</span>`;
                    }

                    tabel += `<tr>
                        <td style="color: var(--text-sub); font-weight: bold;">#${u.id}</td>
                        <td style="font-weight: 600; color: var(--text-main);">${u.username}</td>
                        <td style="color: var(--text-sub); font-size: 13px;">${u.email}</td>
                        <td>${status}</td>
                        <td>${tombolHapus}</td>
                    </tr>`;
                });
                document.getElementById('tabelPtero').innerHTML = tabel;
            })
            .catch(error => {
                document.getElementById('tabelPtero').innerHTML = `<tr><td colspan="5" style="text-align: center; color: var(--danger);">‚ùå Error: ${error.message}</td></tr>`;
            });
        }

        // FUNGSI BUAT USER BARU
        function buatUserPtero() {
            let targetUrl = `${WORKER_URL}/?https://${PTERO_DOMAIN}/api/application/users`;
            let username = document.getElementById('newUsername').value.trim();
            let email = document.getElementById('newEmail').value.trim();
            let password = document.getElementById('newPassword').value.trim();
            
            let isAdmin = document.getElementById('newRole').value === "true"; 

            if(username === "" || email === "" || password === "") {
                alert("Harap isi semua kolom (Username, Email, Password)!");
                return;
            }

            let dataPayload = {
                "email": email,
                "username": username,
                "first_name": username, 
                "last_name": isAdmin ? "Admin" : "User",    
                "password": password,
                "root_admin": isAdmin 
            };

            // Ubah teks tombol loading
            let btn = document.querySelector('.btn-tambah');
            btn.innerText = "Memproses... ‚è≥";
            btn.style.pointerEvents = "none";

            fetch(targetUrl, {
                method: 'POST',
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${PTERO_API}`
                },
                body: JSON.stringify(dataPayload)
            })
            .then(async response => {
                btn.innerText = "üöÄ Buat User Sekarang";
                btn.style.pointerEvents = "auto";
                if (!response.ok) {
                    let err = await response.text();
                    throw new Error(err);
                }
                return response.json();
            })
            .then(data => {
                let statusTeks = isAdmin ? "sebagai ADMIN üëë" : "sebagai MEMBER üë§";
                alert(`‚úÖ Mantap! User ${username} berhasil dibuat ${statusTeks}!`);
                
                document.getElementById('newUsername').value = "";
                document.getElementById('newEmail').value = "";
                document.getElementById('newPassword').value = "";
                document.getElementById('newRole').value = "false"; 
                
                ambilDataPtero(); // Refresh otomatis
            })
            .catch(error => {
                btn.innerText = "üöÄ Buat User Sekarang";
                btn.style.pointerEvents = "auto";
                alert("‚ùå Gagal membuat user: " + error.message);
            });
        }

        // FUNGSI HAPUS USER
        function hapusUserPtero(userId, username) {
            let konfirmasi = confirm(`üö® PERINGATAN!\nYakin ingin menghapus user "${username}" dari Pterodactyl?\n(Server yang terhubung dengan user ini mungkin akan kehilangan pemiliknya).`);
            
            if (!konfirmasi) return; 

            let deleteUrl = `${WORKER_URL}/?https://${PTERO_DOMAIN}/api/application/users/${userId}`;

            fetch(deleteUrl, {
                method: 'DELETE',
                headers: {
                    'Accept': 'application/json',
                    'Authorization': `Bearer ${PTERO_API}`
                }
            })
            .then(async response => {
                if (!response.ok) {
                    let err = await response.text();
                    throw new Error(err);
                }
                alert(`üí• DUAARR! User ${username} berhasil dihapus!`);
                ambilDataPtero(); // Refresh otomatis
            })
            .catch(error => {
                alert("‚ùå Gagal menghapus user: " + error.message);
            });
        }

        ambilDataPtero();
    </script>
</body>
</html>
